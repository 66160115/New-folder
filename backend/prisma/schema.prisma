generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // ‡∏´‡∏£‡∏∑‡∏≠ "postgresql" ‡∏Ø‡∏•‡∏Ø
  url      = env("DATABASE_URL")
}

// ----------------------------------------------
// Model ‡∏´‡∏•‡∏±‡∏Å (Core Models)
// ----------------------------------------------

model User {
  id           Int     @id @default(autoincrement()) @map("user_id")
  name         String
  email        String  @unique @db.VarChar(100)
  phone        String? @db.VarChar(15)
  password     String  @db.VarChar(255)
  role         Role    // ‡πÉ‡∏ä‡πâ Enum ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
  createdAt    DateTime @default(now()) @map("created_at")

  // --- Relations (‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
  submittedTickets Ticket[]       @relation("SubmittedBy") // MVP #1
  assignedTickets  Ticket[]       @relation("AssignedTo")  // MVP #2
  comments         Comment[]      @relation("CommentBy")   // MVP #4
  
  // Relations (‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  loginHistories   LoginHistory[]
  activityLogs     ActivityLog[]
  statusChanges    StatusHistory[]
  attachments      Attachment[]
  notifications    Notification[]

  @@map("User") // ‡∏ö‡∏≠‡∏Å Prisma ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ Table 'User'
}

model Ticket {
  id          Int       @id @default(autoincrement()) @map("ticket_id")
  title       String    @db.VarChar(250)
  description String?
  type        TicketType // Incident, Service_Request, etc.
  urgency     Urgency   @default(MEDIUM) // MVP #1
  status      Status    @default(OPEN)   // MVP #3
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // --- Relations (‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
  // MVP #1: ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏™‡πà‡∏á Ticket
  submittedById Int?     @map("user_id") // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ user_id ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏∏‡∏ì
  submittedBy   User?    @relation("SubmittedBy", fields: [submittedById], references: [id], onUpdate: Cascade, onDelete: SetNull)

  // MVP #2: ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö Ticket (Staff)
  assignedToId Int?
  assignedTo   User?     @relation("AssignedTo", fields: [assignedToId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  // MVP #4: Comments ‡∏Ç‡∏≠‡∏á Ticket ‡∏ô‡∏µ‡πâ
  comments Comment[]

  // Relations (‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  statusHistory StatusHistory[]
  attachments   Attachment[]
  notifications Notification[]

  @@map("Ticket")
}

// üõëüõë (GAP #1) ‡∏ú‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° Model ‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö MVP #4 üõëüõë
model Comment {
  id        Int      @id @default(autoincrement())
  body      String   @db.Text
  createdAt DateTime @default(now())

  // Relation to Ticket
  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  // Relation to User (Who commented)
  authorId Int
  author   User     @relation("CommentBy", fields: [authorId], references: [id], onUpdate: Cascade, onDelete: Cascade)
}


// ----------------------------------------------
// Enums (‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤)
// ----------------------------------------------

enum Role {
  ADMIN
  STAFF
  USER
}

enum TicketType {
  Incident
  Service_Request
  Question
  Bug_Report
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
}

enum Status {
  OPEN
  IN_PROGRESS
  CANCELED
  CLOSED
  PENDING
}

// ----------------------------------------------
// ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Log ‡πÅ‡∏•‡∏∞ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
// ----------------------------------------------

model LoginHistory {
  id        Int       @id @default(autoincrement()) @map("login_id")
  loginTime DateTime  @default(now()) @map("login_time")
  ipAddress String?   @db.VarChar(100) @map("ip_address")
  userId    Int?      @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@map("LoginHistory")
}

model ActivityLog {
  id        Int       @id @default(autoincrement()) @map("log_id")
  action    String    @db.VarChar(200)
  targetId  Int?      @map("target_id")
  logTime   DateTime  @default(now()) @map("log_time")
  userId    Int?      @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  @@map("ActivityLog")
}

model StatusHistory {
  id        Int       @id @default(autoincrement()) @map("history_id")
  oldStatus String?   @db.VarChar(45) @map("old_status")
  newStatus String    @db.VarChar(45) @map("new_status")
  remark    String?
  changedAt DateTime  @default(now()) @map("changed_at")
  ticketId  Int?      @map("ticket_id")
  ticket    Ticket?   @relation(fields: [ticketId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId    Int?      @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  @@map("StatusHistory")
}

model Attachment {
  id         Int       @id @default(autoincrement()) @map("attachment_id")
  filePath   String    @db.VarChar(200) @map("file_path")
  fileType   String?   @db.VarChar(50) @map("file_type")
  uploadedAt DateTime  @default(now()) @map("uploaded_at")
  ticketId   Int?      @map("ticket_id")
  ticket     Ticket?   @relation(fields: [ticketId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId     Int?      @map("user_id")
  user       User?     @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  @@map("Attachment")
}

model Notification {
  id        Int       @id @default(autoincrement()) @map("notification_id")
  message   String
  sentAt    DateTime  @default(now()) @map("sent_at")
  isRead    Boolean   @default(false) @map("is_read")
  ticketId  Int?      @map("ticket_id")
  ticket    Ticket?   @relation(fields: [ticketId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userId    Int?      @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@map("Notification")
}
